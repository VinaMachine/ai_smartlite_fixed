# GitLab CI/CD Pipeline
image: docker:24-dind

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  REGISTRY: $CI_REGISTRY
  IMAGE_PREFIX: $CI_PROJECT_NAME

stages:
  - lint
  - test
  - build
  - deploy
  - cleanup

# Lint Python services
lint:python:
  stage: lint
  image: python:3.11
  parallel:
    matrix:
      - SERVICE: [asr-service, tts-service, llm-service, pipeline-service]
  script:
    - cd apps/$SERVICE
    - pip install flake8 black mypy
    - pip install -r requirements.txt
    - black --check .
    - flake8 .
    - mypy . --ignore-missing-imports
  only:
    - merge_requests
    - main
    - develop

# Lint Gateway (Node.js)
lint:gateway:
  stage: lint
  image: node:20-alpine
  script:
    - cd apps/gateway
    - npm ci
    - npm run lint
  only:
    - merge_requests
    - main
    - develop

# Run tests
test:integration:
  stage: test
  image: node:20
  services:
    - mysql:8.0
    - redis:7-alpine
  variables:
    MYSQL_ROOT_PASSWORD: testpassword
    MYSQL_DATABASE: ai_smartlite_test
    DB_HOST: mysql
    REDIS_URL: redis://redis:6379
  script:
    - cd tests
    - npm ci
    - npm run test:integration
    - npm run test:contract
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: tests/coverage/cobertura-coverage.xml
  only:
    - merge_requests
    - main
    - develop

# Build Docker images
build:images:
  stage: build
  services:
    - docker:24-dind
  parallel:
    matrix:
      - SERVICE: [gateway, asr-service, tts-service, llm-service, pipeline-service]
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $REGISTRY/$IMAGE_PREFIX-$SERVICE:$CI_COMMIT_SHA ./apps/$SERVICE
    - docker push $REGISTRY/$IMAGE_PREFIX-$SERVICE:$CI_COMMIT_SHA
    - docker tag $REGISTRY/$IMAGE_PREFIX-$SERVICE:$CI_COMMIT_SHA $REGISTRY/$IMAGE_PREFIX-$SERVICE:latest
    - docker push $REGISTRY/$IMAGE_PREFIX-$SERVICE:latest
  only:
    - main
    - develop

# Deploy to staging
deploy:staging:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config set-cluster staging --server="$KUBE_URL" --insecure-skip-tls-verify=true
    - kubectl config set-credentials gitlab --token="$KUBE_TOKEN"
    - kubectl config set-context staging --cluster=staging --user=gitlab
    - kubectl config use-context staging
    - kubectl set image deployment/gateway gateway=$REGISTRY/$IMAGE_PREFIX-gateway:$CI_COMMIT_SHA -n staging
    - kubectl set image deployment/asr-service asr-service=$REGISTRY/$IMAGE_PREFIX-asr-service:$CI_COMMIT_SHA -n staging
    - kubectl set image deployment/tts-service tts-service=$REGISTRY/$IMAGE_PREFIX-tts-service:$CI_COMMIT_SHA -n staging
    - kubectl set image deployment/llm-service llm-service=$REGISTRY/$IMAGE_PREFIX-llm-service:$CI_COMMIT_SHA -n staging
    - kubectl set image deployment/pipeline-service pipeline-service=$REGISTRY/$IMAGE_PREFIX-pipeline-service:$CI_COMMIT_SHA -n staging
    - kubectl rollout status deployment/gateway -n staging
  environment:
    name: staging
    url: https://staging.ai-smartlite.com
  only:
    - develop

# Deploy to production
deploy:production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config set-cluster production --server="$KUBE_URL_PROD" --insecure-skip-tls-verify=true
    - kubectl config set-credentials gitlab --token="$KUBE_TOKEN_PROD"
    - kubectl config set-context production --cluster=production --user=gitlab
    - kubectl config use-context production
    - kubectl set image deployment/gateway gateway=$REGISTRY/$IMAGE_PREFIX-gateway:$CI_COMMIT_TAG -n production
    - kubectl set image deployment/asr-service asr-service=$REGISTRY/$IMAGE_PREFIX-asr-service:$CI_COMMIT_TAG -n production
    - kubectl set image deployment/tts-service tts-service=$REGISTRY/$IMAGE_PREFIX-tts-service:$CI_COMMIT_TAG -n production
    - kubectl set image deployment/llm-service llm-service=$REGISTRY/$IMAGE_PREFIX-llm-service:$CI_COMMIT_TAG -n production
    - kubectl set image deployment/pipeline-service pipeline-service=$REGISTRY/$IMAGE_PREFIX-pipeline-service:$CI_COMMIT_TAG -n production
    - kubectl rollout status deployment/gateway -n production
  environment:
    name: production
    url: https://ai-smartlite.com
  when: manual
  only:
    - tags
